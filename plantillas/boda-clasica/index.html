<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invitaci√≥n - Boda cl√°sica</title>

  <!-- Tipograf√≠a (puede cambiarse) -->
  <link href="https://fonts.googleapis.com/css2?family=Alex+Brush&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://firebasestorage.googleapis.com/v0/b/reservaeldia-7a440.firebasestorage.app/o/plantillas%2Fboda-clasica%2Fcss-boda-clasica.css?alt=media&token=dc9aed01-854e-40a6-ba9a-5ca89c2e7806" />

  <style>
   
  </style>
</head>
<body>

  <main class="main-content">

          <!-- üîÅ Bloques flotantes afuera del contenido centrado -->
                <div class="zona-editable">
                  <p class="editable" contenteditable="true" data-id="subtitulo1" style="top: 40px; left: 40px;">
                    ¬°Nos Casamos!
                  </p>
                  <h1 class="editable titulo-nombres" contenteditable="true" data-id="nombres" style="top: 100px; left: 60px;">
                    Agus capo
                  </h1>
                </div>
  

    <section style="height: 300px;">
          <div class="zona-editable">
            <p class="editable" contenteditable="true" data-id="subtitulo" style="cursor: move; position: absolute; user-select: text;top: 20px; left: 50px;">
              ¬°mover!
            </p>
   
          </div>
     </section>
  </main>

<script type="module">
  console.log("‚úÖ Script M√ìDULO cargado");

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import {
    getFirestore, doc, setDoc, updateDoc, getDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signInAnonymously
  } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyALCvU48_HRp26cXpQcTX5S33Adpwfl3z4",
    authDomain: "reservaeldia-7a440.firebaseapp.com",
    projectId: "reservaeldia-7a440"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const slug = new URLSearchParams(window.location.search).get("slug") || "prueba-drag-drop";
  const statusEl = document.getElementById('status'); // opcional
  let currentUser = null;
  let docRef = null;
  let saveTimeout = null;
  let changesToSave = {};

  // Estado visual (opcional)
  function setStatus(msg, error = false) {
    if (!statusEl) return;
    statusEl.textContent = msg;
    statusEl.style.backgroundColor = error ? '#f44336' : '#4CAF50';
    if (!error) {
      setTimeout(() => statusEl.style.backgroundColor = '#333', 2000);
    }
  }

  signInAnonymously(auth).catch(err => {
    console.error("‚ùå Error en login an√≥nimo:", err);
    setStatus("Error de login", true);
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) return;
    currentUser = user;
    setStatus("Conectado");
    docRef = doc(db, "borradores", slug);

    try {
      const snap = await getDoc(docRef);
      if (!snap.exists()) {
        await setDoc(docRef, { userId: user.uid, creado: serverTimestamp() });
      } else {
        const data = snap.data();
        const contenido = data?.contenido || {};
        Object.entries(contenido).forEach(([id, val]) => {
          const el = document.querySelector(`[data-id="${id}"]`);
          if (!el) return;
          el.innerText = val.texto;
          el.style.top = val.top;
          el.style.left = val.left;
        });
      }

      setupDragAndAutoSave();
    } catch (e) {
      console.error("‚ùå Error al cargar documento", e);
      setStatus("Error al cargar", true);
    }
  });

  function setupDragAndAutoSave() {
    document.querySelectorAll(".editable").forEach(el => {
      el.style.position = "absolute";
      el.style.cursor = "move";

      let offsetX = 0;
      let offsetY = 0;
      let isDragging = false;

      el.addEventListener("mousedown", (e) => {
        if (e.target !== el) return;
        isDragging = true;
        offsetX = e.clientX - el.getBoundingClientRect().left;
        offsetY = e.clientY - el.getBoundingClientRect().top;
        el.style.zIndex = 1000;

        const onMouseMove = (e) => {
          if (!isDragging) return;
          el.style.left = `${e.clientX - offsetX}px`;
          el.style.top = `${e.clientY - offsetY}px`;
        };

        const onMouseUp = () => {
          isDragging = false;
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
          el.style.zIndex = "";
          scheduleSave(el);
        };

        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      });

      el.addEventListener("input", () => scheduleSave(el));
    });

    setInterval(() => {
      if (Object.keys(changesToSave).length > 0) saveChanges();
    }, 30000);
  }

  function scheduleSave(el) {
    const id = el.dataset.id;
    changesToSave[id] = {
      texto: el.innerText,
      top: el.style.top,
      left: el.style.left
    };

    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveChanges, 1000);
  }

  async function saveChanges() {
    if (!currentUser || !docRef || Object.keys(changesToSave).length === 0) return;

    try {
      setStatus("Guardando...");
      await updateDoc(docRef, {
        contenido: changesToSave,
        ultimaEdicion: serverTimestamp()
      });
      console.log("‚úÖ Guardado:", changesToSave);
      changesToSave = {};
      setStatus("Guardado");
    } catch (e) {
      console.error("‚ùå Error al guardar:", e);
      setStatus("Error al guardar", true);
    }
  }
</script>



</body>
</html>
