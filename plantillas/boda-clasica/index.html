<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invitación - Boda clásica</title>

  <!-- Tipografía (puede cambiarse) -->
  <link href="https://fonts.googleapis.com/css2?family=Alex+Brush&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://firebasestorage.googleapis.com/v0/b/reservaeldia-7a440.firebasestorage.app/o/plantillas%2Fboda-clasica%2Fcss-boda-clasica.css?alt=media&token=dc9aed01-854e-40a6-ba9a-5ca89c2e7806" />

</head>
<body>

  <main class="main-content">

    <!-- ✅ PORTADA INCLUIDA -->
    <section class="portada">
      <div class="portada-parallax">
        <div class="portada-contenido">
          <p class="subtitulo editable" contenteditable="true" data-id="subtitulo">¡Nos Casamos!</p>
          <h1 class="editable titulo-nombres" contenteditable="true" data-id="nombres">Juli & Santi</h1>
          <img src="https://firebasestorage.googleapis.com/v0/b/reservaeldia-7a440.firebasestorage.app/o/plantillas%2Fboda-clasica%2Fimg%2Fportada-editable1.png?alt=media&token=b5fbcbe6-99c9-4cb1-ae99-44260fbbea95" alt="Hoja decorativa" class="imagen-portada">
        </div>
      </div>
    </section>

    <!-- Cuenta regresiva -->
    <section id="cuentaRegresiva" class="cuenta-regresiva text-center py-5">
      <h2 class="editable" contenteditable="true" data-id="mensajeCuentaRegresiva">¡Faltan pocos días para el gran día!</h2>
      <div id="reloj" class="reloj">
        <span id="dias">00</span>d :
        <span id="horas">00</span>h :
        <span id="min">00</span>min :
        <span id="seg">00</span>s
      </div>
    </section>

    <!-- Datos del evento -->
    <section class="text-center py-5">
      <h4 class="editable" contenteditable="true" data-id="tituloEvento">Nuestra boda</h4>
      <p class="editable" contenteditable="true" data-id="datos-evento">
        15 de julio de 2025 a las 20:00 hs en Friendly.<br>¡Te esperamos!
      </p>
    </section>

    <!-- Galería -->
    <section id="galeria" class="galeria text-center py-5">
      <h4 class="editable" contenteditable="true" data-id="galeriaTitulo">Nosotros...</h4>
      <p class="editable" contenteditable="true" data-id="galeriaTexto">Galería de imágenes de la pareja</p>
    </section>

    <!-- Dress code -->
    <section id="dresscode" class="dresscode text-center py-5">
      <h4 class="editable" contenteditable="true" data-id="dresscodeTitulo">DRESS CODE</h4>
      <p class="editable" contenteditable="true" data-id="dresscodeValor">Cocktail</p>
    </section>

    <!-- Confirmación -->
    <section id="confirmacion" class="confirmacion text-center py-5">
      <h4 class="editable" contenteditable="true" data-id="confirmacionTitulo">Confirmación de asistencia</h4>
      <p class="editable" contenteditable="true" data-id="confirmacionTexto">Confirmá antes del 1 de marzo de 2025</p>
      <button class="btn-confirmar" id="btn-publicar">Generar invitación</button>
    </section>

    <!-- Footer -->
    <footer class="text-center py-4">
      <p>&copy; 2025 Reserva el Día - Todos los derechos reservados</p>
    </footer>

  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function () {
    const slug = new URLSearchParams(window.location.search).get("slug");

    // ✅ Botón para generar la invitación final
    const btn = document.getElementById('btn-publicar');

    if (btn) {
      btn.addEventListener('click', async () => {
        const slugBorrador = slug;

        const nombres = document.querySelector('[data-id="nombres"]')?.innerText.trim();
        const datosEvento = document.querySelector('[data-id="datos-evento"]')?.innerText.trim();

        if (!nombres || !datosEvento) {
          alert('Faltan datos obligatorios (nombres o evento).');
          return;
        }

        const nombresSlug = nombres
          .toLowerCase()
          .replace(/[^a-z0-9áéíóúñü\s]/gi, '')
          .replace(/\s+/g, '-')
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "");

        let fechaSlug = '';
        const fechaRegex1 = /\d{1,2} de [a-zA-Z]+ de \d{4}/;
        const fechaRegex2 = /\d{4}-\d{2}-\d{2}/;
        const match = datosEvento.match(fechaRegex1) || datosEvento.match(fechaRegex2);

        if (match) {
          fechaSlug = match[0]
            .toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/[^\w-]/g, '');
        } else {
          fechaSlug = Date.now();
        }

        const slugFinal = `${nombresSlug}-${fechaSlug}`;

        try {
          const res = await fetch('/api/publicar-invitacion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ slugBorrador, slugFinal })
          });

          const data = await res.json();

          if (res.ok) {
            window.location.href = `${data.url}index.html`;
          } else {
            alert('Error: ' + data.error);
          }
        } catch (err) {
          console.error('❌ Error:', err);
          alert('No se pudo generar la invitación.');
        }
      });
    }

    // ✅ Función para obtener todos los overrides del DOM
    const getOverrides = () => {
      const elementos = document.querySelectorAll("[data-id]");
      const datos = {};
      elementos.forEach(el => {
        datos[el.dataset.id] = el.innerHTML;
      });
      return datos;
    };

    // ✅ Guardar automáticamente cada 2 segundos
    const guardarCambios = async () => {
      const overrides = getOverrides();
      try {
        await fetch(`https://us-central1-reservaeldia-7a440.cloudfunctions.net/guardarEdicion`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ slug, overrides })
        });
        console.log("✅ Guardado automático");
      } catch (err) {
        console.error("❌ Error al guardar", err);
      }
    };

    setInterval(guardarCambios, 2000);

    // ✅ Al cargar la página, aplicar overrides
    const aplicarOverrides = async () => {
      try {
        const response = await fetch(`https://us-central1-reservaeldia-7a440.cloudfunctions.net/leerEdicion?slug=${slug}`);
        const data = await response.json();
        const overrides = data.overrides || {};

        Object.entries(overrides).forEach(([id, contenido]) => {
          const el = document.querySelector(`[data-id="${id}"]`);
          if (el) el.innerHTML = contenido;
        });
      } catch (err) {
        console.error("❌ No se pudieron aplicar los overrides", err);
      }
    };

    aplicarOverrides();
  });
</script>

</body>
</html>
